name: Deploy via SSH

on:
  push:
    branches:
      - main

jobs:
  ssh-deploy:
    runs-on: ubuntu-latest
    environment: producao
    steps:
      - name: Setup SSH
        run: |
          echo "üîß Configurando SSH..."
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          echo "‚úÖ SSH configurado com sucesso!"

      - name: Deploy Laravel
        run: |
          echo "üöÄ Iniciando deploy..."
          echo "üìã Informa√ß√µes do servidor:"
          echo "   Host: ${{ secrets.SSH_HOST }}"
          echo "   Porta: ${{ secrets.SSH_PORT }}"
          echo "   Usu√°rio: ${{ secrets.SSH_USER }}"
          echo "   Diret√≥rio: ${{ secrets.SSH_DIRECTORY }}"
          echo ""
          
          sshpass -p "${{ secrets.SSH_PASSPHRASE }}" ssh -p ${{ secrets.SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "SSH_DIR='${{ secrets.SSH_DIRECTORY }}' && \
            SSH_HOST='${{ secrets.SSH_HOST }}' && \
            echo 'üìÅ Acessando diret√≥rio do projeto...' && \
            cd \"\$SSH_DIR\" || { echo '‚ùå ERRO: N√£o foi poss√≠vel acessar o diret√≥rio'; exit 1; } && \
            echo '‚úÖ Diret√≥rio atual:' && pwd && \
            echo '' && \
            echo 'üîÑ Atualizando c√≥digo do reposit√≥rio...' && \
            if [ -d .git ]; then \
              git fetch origin || echo '‚ö†Ô∏è  Aviso: Erro ao fazer fetch' && \
              git pull origin main || echo '‚ö†Ô∏è  Aviso: Erro ao fazer pull' && \
              echo '‚úÖ C√≥digo atualizado!' && \
              echo 'üìù Commit atual:' && git log -1 --oneline || echo '‚ö†Ô∏è  N√£o foi poss√≠vel verificar commit'; \
            else \
              echo '‚ö†Ô∏è  Aviso: Diret√≥rio n√£o √© um reposit√≥rio Git. Pulando atualiza√ß√£o.'; \
            fi && \
            echo '' && \
            echo 'üîç Verificando PHP...' && \
            command -v php >/dev/null 2>&1 || { echo '‚ùå ERRO: PHP n√£o est√° instalado'; exit 1; } && \
            echo '‚úÖ PHP encontrado:' && php -v | head -1 && \
            echo '' && \
            echo 'üîç Verificando Composer...' && \
            if command -v composer >/dev/null 2>&1; then \
              COMPOSER_CMD='composer' && \
              echo '‚úÖ Composer encontrado no PATH'; \
            elif [ -f composer.phar ]; then \
              COMPOSER_CMD='php composer.phar' && \
              echo '‚úÖ Composer encontrado (composer.phar)'; \
            else \
              echo 'üì¶ Composer n√£o encontrado. Instalando...' && \
              curl -sS https://getcomposer.org/installer | php && \
              if [ -f composer.phar ]; then \
                COMPOSER_CMD='php composer.phar' && \
                echo '‚úÖ Composer instalado com sucesso!'; \
              else \
                echo '‚ùå ERRO: Falha ao instalar Composer' && \
                exit 1; \
              fi; \
            fi && \
            echo 'üìä Vers√£o do Composer:' && \
            if [ \"\$COMPOSER_CMD\" = 'php composer.phar' ]; then \
              php composer.phar --version; \
            else \
              \$COMPOSER_CMD --version; \
            fi && \
            echo '' && \
            echo 'üì¶ Instalando depend√™ncias do Laravel...' && \
            if [ \"\$COMPOSER_CMD\" = 'php composer.phar' ]; then \
              php composer.phar install --no-dev --optimize-autoloader --no-interaction; \
            else \
              \$COMPOSER_CMD install --no-dev --optimize-autoloader --no-interaction; \
            fi && \
            echo '‚úÖ Depend√™ncias instaladas com sucesso!' && \
            echo '' && \
            echo 'üîß Configurando Laravel...' && \
            if [ ! -f .env ]; then \
              echo '‚ö†Ô∏è  Arquivo .env n√£o encontrado. Criando a partir do .env.example...' && \
              cp .env.example .env 2>/dev/null || echo '‚ö†Ô∏è  .env.example n√£o encontrado'; \
            fi && \
            php artisan key:generate --force 2>/dev/null || echo '‚ö†Ô∏è  Chave j√° existe ou erro ao gerar' && \
            echo '‚úÖ Laravel configurado!' && \
            echo '' && \
            echo 'üóÑÔ∏è  Executando migrations...' && \
            php artisan migrate --force || echo '‚ö†Ô∏è  Aviso: Erro ao executar migrations (pode ser normal se j√° estiverem executadas)' && \
            echo '' && \
            echo 'üßπ Limpando caches...' && \
            php artisan config:clear || true && \
            php artisan cache:clear || true && \
            php artisan view:clear || true && \
            php artisan route:clear || true && \
            echo '‚úÖ Caches limpos!' && \
            echo '' && \
            echo '‚ö° Otimizando aplica√ß√£o...' && \
            php artisan config:cache || true && \
            php artisan route:cache || true && \
            php artisan optimize || true && \
            echo '‚úÖ Aplica√ß√£o otimizada!' && \
            echo '' && \
            echo 'üéâ Deploy conclu√≠do com sucesso!' && \
            echo 'üìä Status final:' && \
            echo \"   - Diret√≥rio: \$(pwd)\" && \
            echo \"   - PHP: \$(php -v | head -1 | cut -d' ' -f1-3)\" && \
            if [ \"\$COMPOSER_CMD\" = 'php composer.phar' ]; then \
              COMPOSER_VERSION=\$(php composer.phar --version | head -1); \
            else \
              COMPOSER_VERSION=\$(\$COMPOSER_CMD --version | head -1); \
            fi && \
            echo \"   - Composer: \$COMPOSER_VERSION\" && \
            echo '   - Servidor: O servidor web do host serve a aplica√ß√£o automaticamente' && \
            echo \"   - Aplica√ß√£o: Pronta para uso em http://\$SSH_HOST\""
          
          echo ""
          echo "‚úÖ Deploy finalizado com sucesso!"
          echo "üìù Nota: Em servidores compartilhados, o servidor web (Apache/Nginx) serve a aplica√ß√£o automaticamente"
          echo "üåê Acesse sua aplica√ß√£o atrav√©s do dom√≠nio configurado no seu host"
