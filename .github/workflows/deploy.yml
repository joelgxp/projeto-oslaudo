name: Deploy via SSH

on:
  push:
    branches:
      - main

jobs:
  ssh-deploy:
    runs-on: ubuntu-latest
    environment: producao
    steps:
      - name: Setup SSH
        run: |
          echo "üîß Configurando SSH..."
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          echo "‚úÖ SSH configurado com sucesso!"

      - name: Deploy e Iniciar Servidor
        run: |
          echo "üöÄ Iniciando deploy..."
          echo "üìã Informa√ß√µes do servidor:"
          echo "   Host: ${{ secrets.SSH_HOST }}"
          echo "   Porta: ${{ secrets.SSH_PORT }}"
          echo "   Usu√°rio: ${{ secrets.SSH_USER }}"
          echo "   Diret√≥rio: ${{ secrets.SSH_DIRECTORY }}"
          echo ""
          
          sshpass -p "${{ secrets.SSH_PASSPHRASE }}" ssh -p ${{ secrets.SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH
            SSH_DIR="${{ secrets.SSH_DIRECTORY }}"
            SSH_HOST="${{ secrets.SSH_HOST }}"
            echo "üìÅ Acessando diret√≥rio do projeto..."
            cd "\$SSH_DIR" || { echo "‚ùå ERRO: N√£o foi poss√≠vel acessar o diret√≥rio \$SSH_DIR"; exit 1; }
            echo "‚úÖ Diret√≥rio atual: \$(pwd)"
            echo ""
            
            echo "üîç Verificando PHP..."
            if ! command -v php >/dev/null 2>&1; then
              echo "‚ùå ERRO: PHP n√£o est√° instalado"
              exit 1
            fi
            echo "‚úÖ PHP encontrado: $(php -v | head -1)"
            echo ""
            
            echo "üîç Verificando Composer..."
            if command -v composer >/dev/null 2>&1; then
              COMPOSER_CMD="composer"
              echo "‚úÖ Composer encontrado no PATH"
            elif [ -f composer.phar ]; then
              COMPOSER_CMD="php composer.phar"
              echo "‚úÖ Composer encontrado (composer.phar)"
            else
              echo "üì¶ Composer n√£o encontrado. Instalando..."
              curl -sS https://getcomposer.org/installer | php
              if [ -f composer.phar ]; then
                COMPOSER_CMD="php composer.phar"
                echo "‚úÖ Composer instalado com sucesso!"
              else
                echo "‚ùå ERRO: Falha ao instalar Composer"
                exit 1
              fi
            fi
            echo "üìä Vers√£o do Composer:"
            if [ "\$COMPOSER_CMD" = "php composer.phar" ]; then
              php composer.phar --version
            else
              \$COMPOSER_CMD --version
            fi
            echo ""
            
            echo "üì¶ Instalando depend√™ncias do Laravel..."
            if [ "\$COMPOSER_CMD" = "php composer.phar" ]; then
              php composer.phar install --no-dev --optimize-autoloader --no-interaction
            else
              \$COMPOSER_CMD install --no-dev --optimize-autoloader --no-interaction
            fi
            echo "‚úÖ Depend√™ncias instaladas com sucesso!"
            echo ""
            
            echo "üîß Configurando Laravel..."
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  Arquivo .env n√£o encontrado. Criando a partir do .env.example..."
              cp .env.example .env 2>/dev/null || echo "‚ö†Ô∏è  .env.example n√£o encontrado"
            fi
            php artisan key:generate --force 2>/dev/null || echo "‚ö†Ô∏è  Chave j√° existe ou erro ao gerar"
            echo "‚úÖ Laravel configurado!"
            echo ""
            
            echo "üóÑÔ∏è  Executando migrations..."
            php artisan migrate --force || echo "‚ö†Ô∏è  Aviso: Erro ao executar migrations (pode ser normal se j√° estiverem executadas)"
            echo ""
            
            echo "üßπ Limpando caches..."
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan view:clear || true
            php artisan route:clear || true
            echo "‚úÖ Caches limpos!"
            echo ""
            
            echo "‚ö° Otimizando aplica√ß√£o..."
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan optimize || true
            echo "‚úÖ Aplica√ß√£o otimizada!"
            echo ""
            
            echo "üöÄ Iniciando servidor Laravel..."
            echo "üìù O servidor ser√° iniciado em background na porta 8000"
            echo "üåê Acesse: http://\$SSH_HOST:8000"
            echo ""
            
            # Para o servidor anterior se estiver rodando
            pkill -f "artisan serve" || true
            sleep 2
            
            # Inicia o servidor em background
            nohup php artisan serve --host=0.0.0.0 --port=8000 > storage/logs/server.log 2>&1 &
            SERVER_PID=\$!
            sleep 3
            
            # Verifica se o servidor est√° rodando
            if ps -p \$SERVER_PID > /dev/null 2>&1; then
              echo "‚úÖ Servidor iniciado com sucesso! (PID: \$SERVER_PID)"
              echo "üìã Logs do servidor: storage/logs/server.log"
            else
              echo "‚ö†Ô∏è  Verificando se o servidor est√° rodando de outra forma..."
              if pgrep -f "artisan serve" > /dev/null; then
                ACTUAL_PID=\$(pgrep -f "artisan serve" | head -1)
                echo "‚úÖ Servidor est√° rodando! (PID: \$ACTUAL_PID)"
                echo "üìã Logs do servidor: storage/logs/server.log"
              else
                echo "‚ùå ERRO: Falha ao iniciar o servidor"
                echo "üìã √öltimas linhas do log:"
                tail -20 storage/logs/server.log 2>/dev/null || echo "Log n√£o dispon√≠vel"
                exit 1
              fi
            fi
            echo ""
            
            echo "üéâ Deploy conclu√≠do com sucesso!"
            echo "üìä Status final:"
            echo "   - Diret√≥rio: \$(pwd)"
            echo "   - PHP: \$(php -v | head -1 | cut -d' ' -f1-3)"
            if [ "\$COMPOSER_CMD" = "php composer.phar" ]; then
              COMPOSER_VERSION=\$(php composer.phar --version | head -1)
            else
              COMPOSER_VERSION=\$(\$COMPOSER_CMD --version | head -1)
            fi
            echo "   - Composer: \$COMPOSER_VERSION"
            SERVER_PID_FINAL=\$(pgrep -f "artisan serve" | head -1 || echo "N/A")
            echo "   - Servidor: Rodando (PID: \$SERVER_PID_FINAL)"
          ENDSSH
          
          echo ""
          echo "üåê Verificando se o servidor est√° respondendo..."
          sleep 5
          if curl -f -s -o /dev/null -w "%{http_code}" --max-time 10 "http://${{ secrets.SSH_HOST }}:8000" | grep -q "200\|301\|302"; then
            echo "‚úÖ Servidor est√° respondendo corretamente!"
            echo "üåê URL: http://${{ secrets.SSH_HOST }}:8000"
          else
            echo "‚ö†Ô∏è  Aviso: N√£o foi poss√≠vel verificar a resposta do servidor (pode estar iniciando ainda)"
            echo "üåê Tente acessar: http://${{ secrets.SSH_HOST }}:8000"
          fi
          echo ""
          echo "‚úÖ Deploy finalizado com sucesso!"
