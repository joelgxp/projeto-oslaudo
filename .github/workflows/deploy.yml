name: Deploy via SSH

on:
  push:
    branches:
      - main

jobs:
  ssh-deploy:
    runs-on: ubuntu-latest
    environment: producao
    steps:
      - name: Setup SSH
        run: |
          echo "ðŸ”§ Configurando SSH..."
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… SSH configurado com sucesso!"

      - name: Deploy e Iniciar Servidor
        run: |
          echo "ðŸš€ Iniciando deploy..."
          echo "ðŸ“‹ InformaÃ§Ãµes do servidor:"
          echo "   Host: ${{ secrets.SSH_HOST }}"
          echo "   Porta: ${{ secrets.SSH_PORT }}"
          echo "   UsuÃ¡rio: ${{ secrets.SSH_USER }}"
          echo "   DiretÃ³rio: ${{ secrets.SSH_DIRECTORY }}"
          echo ""
          
          sshpass -p "${{ secrets.SSH_PASSPHRASE }}" ssh -p ${{ secrets.SSH_PORT }} -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << ENDSSH
            set -e
            SSH_DIR="${{ secrets.SSH_DIRECTORY }}"
            SSH_HOST="${{ secrets.SSH_HOST }}"
            echo "ðŸ“ Acessando diretÃ³rio do projeto..."
            cd \$SSH_DIR || { echo "âŒ ERRO: NÃ£o foi possÃ­vel acessar o diretÃ³rio"; exit 1; }
            echo "âœ… DiretÃ³rio atual: $(pwd)"
            echo ""
            
            echo "ðŸ” Verificando PHP..."
            if ! command -v php >/dev/null 2>&1; then
              echo "âŒ ERRO: PHP nÃ£o estÃ¡ instalado"
              exit 1
            fi
            echo "âœ… PHP encontrado: $(php -v | head -1)"
            echo ""
            
            echo "ðŸ” Verificando Composer..."
            if command -v composer >/dev/null 2>&1; then
              COMPOSER_CMD="composer"
              echo "âœ… Composer encontrado no PATH"
            elif [ -f composer.phar ]; then
              COMPOSER_CMD="php composer.phar"
              echo "âœ… Composer encontrado (composer.phar)"
            else
              echo "ðŸ“¦ Composer nÃ£o encontrado. Instalando..."
              curl -sS https://getcomposer.org/installer | php
              if [ -f composer.phar ]; then
                COMPOSER_CMD="php composer.phar"
                echo "âœ… Composer instalado com sucesso!"
              else
                echo "âŒ ERRO: Falha ao instalar Composer"
                exit 1
              fi
            fi
            echo "ðŸ“Š VersÃ£o do Composer:"
            if [ "\$COMPOSER_CMD" = "php composer.phar" ]; then
              php composer.phar --version
            else
              \$COMPOSER_CMD --version
            fi
            echo ""
            
            echo "ðŸ“¦ Instalando dependÃªncias do Laravel..."
            if [ "\$COMPOSER_CMD" = "php composer.phar" ]; then
              php composer.phar install --no-dev --optimize-autoloader --no-interaction
            else
              \$COMPOSER_CMD install --no-dev --optimize-autoloader --no-interaction
            fi
            echo "âœ… DependÃªncias instaladas com sucesso!"
            echo ""
            
            echo "ðŸ”§ Configurando Laravel..."
            if [ ! -f .env ]; then
              echo "âš ï¸  Arquivo .env nÃ£o encontrado. Criando a partir do .env.example..."
              cp .env.example .env 2>/dev/null || echo "âš ï¸  .env.example nÃ£o encontrado"
            fi
            php artisan key:generate --force 2>/dev/null || echo "âš ï¸  Chave jÃ¡ existe ou erro ao gerar"
            echo "âœ… Laravel configurado!"
            echo ""
            
            echo "ðŸ—„ï¸  Executando migrations..."
            php artisan migrate --force || echo "âš ï¸  Aviso: Erro ao executar migrations (pode ser normal se jÃ¡ estiverem executadas)"
            echo ""
            
            echo "ðŸ§¹ Limpando caches..."
            php artisan config:clear || true
            php artisan cache:clear || true
            php artisan view:clear || true
            php artisan route:clear || true
            echo "âœ… Caches limpos!"
            echo ""
            
            echo "âš¡ Otimizando aplicaÃ§Ã£o..."
            php artisan config:cache || true
            php artisan route:cache || true
            php artisan optimize || true
            echo "âœ… AplicaÃ§Ã£o otimizada!"
            echo ""
            
            echo "ðŸš€ Iniciando servidor Laravel..."
            echo "ðŸ“ O servidor serÃ¡ iniciado em background na porta 8000"
            echo "ðŸŒ Acesse: http://\$SSH_HOST:8000"
            echo ""
            
            # Para o servidor anterior se estiver rodando
            pkill -f "artisan serve" || true
            sleep 2
            
            # Inicia o servidor em background
            nohup php artisan serve --host=0.0.0.0 --port=8000 > storage/logs/server.log 2>&1 &
            SERVER_PID=$!
            sleep 3
            
            # Verifica se o servidor estÃ¡ rodando
            if ps -p $SERVER_PID > /dev/null; then
              echo "âœ… Servidor iniciado com sucesso! (PID: $SERVER_PID)"
              echo "ðŸ“‹ Logs do servidor: storage/logs/server.log"
            else
              echo "âŒ ERRO: Falha ao iniciar o servidor"
              echo "ðŸ“‹ Ãšltimas linhas do log:"
              tail -20 storage/logs/server.log 2>/dev/null || echo "Log nÃ£o disponÃ­vel"
              exit 1
            fi
            echo ""
            
            echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
            echo "ðŸ“Š Status final:"
            echo "   - DiretÃ³rio: $(pwd)"
            echo "   - PHP: $(php -v | head -1 | cut -d' ' -f1-3)"
            if [ "\$COMPOSER_CMD" = "php composer.phar" ]; then
              COMPOSER_VERSION=\$(php composer.phar --version | head -1)
            else
              COMPOSER_VERSION=\$(\$COMPOSER_CMD --version | head -1)
            fi
            echo "   - Composer: \$COMPOSER_VERSION"
            echo "   - Servidor: Rodando (PID: $SERVER_PID)"
          ENDSSH
          
          echo ""
          echo "âœ… Deploy finalizado com sucesso!"
